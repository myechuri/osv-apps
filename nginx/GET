#!/bin/sh

set -e

# TODO: gather version number from input.
VERSION=1.9.15
BASEDIR=$PWD
SRCDIR=$BASEDIR/nginx-$VERSION
BUILDDIR=$BASEDIR/build
ROOTDIR=$BASEDIR/install
OUTDIR=$BASEDIR/out

# Gather Nginx source for desired version.
echo "Getting Nginx source version" $VERSION
if [ ! -f nginx-$VERSION.tar.gz ]; then
    wget nginx.org/download/nginx-$VERSION.tar.gz
fi
tar zxf nginx-$VERSION.tar.gz

# Configure build options.
echo "Configuring Nginx build options.."
cd $SRCDIR
./configure --with-debug --without-http_rewrite_module --with-cc-opt='-O2 -D_FORTIFY_SOURCE=2 -fPIC' --with-ld-opt='-pie'

# Build Nginx from source.
echo "Building Nginx from source.."
cp $BASEDIR/nginx.conf $SRCDIR/conf/nginx.conf
cp $BASEDIR/ngx_process.c $SRCDIR/src/os/unix/ngx_process.c
make
mkdir $OUTDIR
cp objs/nginx $OUTDIR/nginx.so
cp conf/mime.types $OUTDIR/mime.types

# Generate usr.manifest.
mkdir $BASEDIR/logs
echo "Generating usr.manifest.."
cd $BASEDIR
cat > usr.manifest <<EOF
# This file is automatically generated
/tools/nginx.so: \${MODULE_DIR}/out/nginx.so
/usr/local/nginx/conf/nginx.conf: \${MODULE_DIR}/nginx.conf
/usr/local/nginx/conf/mime.types: \${MODULE_DIR}/out/mime.types
/usr/local/nginx/logs: \${MODULE_DIR}/logs
EOF

