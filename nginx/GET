#!/bin/sh

set -e

# TODO: gather version number from input.
VERSION=1.9.15
BASEDIR=$PWD
SRCDIR=$BASEDIR/nginx-$VERSION
BUILDDIR=$BASEDIR/build
ROOTDIR=$BASEDIR/install
OUTDIR=$BASEDIR/out

echo "Getting Nginx source version" $VERSION
if [ ! -f nginx-$VERSION.tar.gz ]; then
    wget nginx.org/download/nginx-$VERSION.tar.gz
fi
tar zxf nginx-$VERSION.tar.gz

echo "Configuring Nginx build options.."
cd $SRCDIR
./configure --without-http_rewrite_module --with-cc-opt='-O2 -D_FORTIFY_SOURCE=2 -fPIC' --with-ld-opt='-pie'

make
mkdir $OUTDIR
cp objs/nginx $OUTDIR/nginx.so
cp conf/mime.types $OUTDIR/mime.types

cd $BASEDIR
cat > usr.manifest <<EOF
# This file is automatically generated
/tools/nginx.so: \${MODULE_DIR}/out/nginx.so
/usr/local/nginx/conf/nginx.conf: \${MODULE_DIR}/nginx.conf
/usr/local/nginx/conf/mime.types: \${MODULE_DIR}/out/mime.types
EOF

